package config

import (
	"context"
	"fmt"
	"log"
	"os"

	"github.com/jackc/pgx/v5"
	"github.com/joho/godotenv"
)

var DB *pgx.Conn
var SupabaseProjectRef string

func ConnectDB() {
	// 1. ‡πÇ‡∏´‡∏•‡∏î .env
	err := godotenv.Load()
	if err != nil {
		log.Println("Warning: No .env file found")
	}

	// 2. ‡πÇ‡∏´‡∏•‡∏î Database URL
	databaseURL := os.Getenv("DATABASE_URL")
	if databaseURL == "" {
		log.Fatal("DATABASE_URL is not set")
	}

	SupabaseProjectRef = os.Getenv("SUPABASE_PROJECT_REF")
	if SupabaseProjectRef == "" {
		log.Fatal("SUPABASE_PROJECT_REF is not set")
	}

	// 3. ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Use ParseConfig to disable prepared statements for Supabase/PgBouncer)
	config, err := pgx.ParseConfig(databaseURL)
	if err != nil {
		log.Fatal("‚ùå Failed to parse config:", err)
	}

	// ‚ö†Ô∏è Fix for "prepared statement already exists" error
	config.DefaultQueryExecMode = pgx.QueryExecModeSimpleProtocol

	DB, err = pgx.ConnectConfig(context.Background(), config)
	if err != nil {
		log.Fatal("‚ùå DB connection failed:", err)
	}

	log.Println("‚úÖ Connected to Supabase DB (Simple Protocol)")
}

// ‚úÖ [‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ] ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Reset Database
func ResetDatabase() {
	if DB == nil {
		log.Fatal("‚ùå Database connection is not initialized")
	}

	fmt.Println("‚è≥ Starting Database Migration...")
	ctx := context.Background()

	// 1. ‡∏•‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏Å‡πà‡∏≤ (Drop)
	_, err := DB.Exec(ctx, dropSchemaSQL)
	if err != nil {
		log.Fatalf("‚ùå Error dropping tables: %v", err)
	}
	fmt.Println("üî• Old tables dropped.")

	// 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà (Create)
	_, err = DB.Exec(ctx, createSchemaSQL)
	if err != nil {
		log.Fatalf("‚ùå Error creating tables: %v", err)
	}
	fmt.Println("üéâ All tables created successfully!")
}

// ... (‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì) ...

// ‚úÖ [‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ] ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏ö Policy ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡∏∞‡∏õ‡∏¥‡∏î RLS
func DisableRLS() {
	if DB == nil {
		log.Fatal("‚ùå Database connection is not initialized")
	}

	fmt.Println("‚è≥ Disabling Row Level Security (RLS)...")
	ctx := context.Background()

	_, err := DB.Exec(ctx, disableRLSSQL)
	if err != nil {
		log.Fatalf("‚ùå Error disabling RLS: %v", err)
	}

	fmt.Println("üîì RLS Disabled & Policies Dropped successfully!")
}

// SQL ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏¢‡πâ‡∏≠‡∏ô‡∏®‡∏£‡∏à‡∏≤‡∏Å‡∏•‡∏π‡∏Å‡πÑ‡∏õ‡∏´‡∏≤‡πÅ‡∏°‡πà)
const dropSchemaSQL = `
	-- ‡∏•‡∏ö Trigger/Function ‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö Level
    DROP TRIGGER IF EXISTS on_character_exp_change ON public.characters;
    DROP FUNCTION IF EXISTS public.handle_character_exp_update();
    DROP FUNCTION IF EXISTS public.calculate_level_from_exp(int);

	DROP TRIGGER IF EXISTS on_auth_user_created_character ON auth.users;
    DROP TRIGGER IF EXISTS on_auth_user_created ON auth.users;
    DROP FUNCTION IF EXISTS public.handle_new_user_character();
    DROP FUNCTION IF EXISTS public.handle_new_user();

	DROP TABLE IF EXISTS public.receive CASCADE;
	DROP TABLE IF EXISTS public.give CASCADE;
	DROP TABLE IF EXISTS public.attain CASCADE;
	DROP TABLE IF EXISTS public.collect CASCADE;
	DROP TABLE IF EXISTS public.do_quests CASCADE;
	DROP TABLE IF EXISTS public.obtain CASCADE;
	DROP TABLE IF EXISTS public.wear CASCADE;
	DROP TABLE IF EXISTS public.take CASCADE;
	DROP TABLE IF EXISTS public.get_notifications CASCADE;
	DROP TABLE IF EXISTS public.conduct CASCADE;
	
	DROP TABLE IF EXISTS public.exams CASCADE;
	DROP TABLE IF EXISTS public.quests CASCADE;
	DROP TABLE IF EXISTS public.items CASCADE;
	DROP TABLE IF EXISTS public.characters CASCADE;
	DROP TABLE IF EXISTS public.user_profiles CASCADE;
	
	DROP TABLE IF EXISTS public.achievements CASCADE;
	DROP TABLE IF EXISTS public.categories CASCADE;
	DROP TABLE IF EXISTS public.clubs CASCADE;
	DROP TABLE IF EXISTS public.notifications CASCADE;
	DROP TABLE IF EXISTS public.maps CASCADE;
`

// SQL ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå)
const createSchemaSQL = `
	-- LEVEL 1: Table ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ FK
	CREATE TABLE public.maps (
		id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
		name text NOT NULL,
		detail text,
		image text
	);

	CREATE TABLE public.notifications (
		id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
		title text NOT NULL,
		detail text,
		type text,
		image text,
		start_date timestamp with time zone,
		due_date timestamp with time zone
	);

	CREATE TABLE public.clubs (
		id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
		name text NOT NULL,
		description text,
		created_at timestamp with time zone DEFAULT now()
	);

	CREATE TABLE public.categories (
		id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
		name text NOT NULL,
		description text
	);

	CREATE TABLE public.achievements (
		id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
		name text NOT NULL,
		description text
	);

	-- LEVEL 2: Table ‡∏ó‡∏µ‡πà‡∏°‡∏µ FK
	CREATE TABLE public.user_profiles (
		id uuid REFERENCES auth.users ON DELETE CASCADE PRIMARY KEY,
		name text,
		email text,
		detail text,
		created_at timestamp with time zone DEFAULT now(),
		club_id bigint REFERENCES public.clubs(id) ON DELETE SET NULL,
		club_join_date timestamp with time zone,
		club_role text
	);

	CREATE TABLE public.characters (
		id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
		user_id uuid REFERENCES public.user_profiles(id) ON DELETE CASCADE NOT NULL UNIQUE,
		level int DEFAULT 1 NOT NULL,
		experience int DEFAULT 0 NOT NULL,
		gender text DEFAULT 'FEMALE' NOT NULL,
		skin_color text DEFAULT 'WHITE' NOT NULL,
		emotion text DEFAULT 'NORMAL' NOT NULL,
		body_type text DEFAULT 'KID' NOT NULL,
		intelligence int DEFAULT 10 NOT NULL,
		strength int DEFAULT 10 NOT NULL,
		creative int DEFAULT 10 NOT NULL,
		stamina int DEFAULT 100 NOT NULL CHECK (stamina >= 0 AND stamina <= 100)
	);

	CREATE TABLE public.items (
		id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
		name text NOT NULL,
		description text,
		image text,
		rarity text,
		category_id bigint REFERENCES public.categories(id) ON DELETE SET NULL
	);

	CREATE TABLE public.quests (
		id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
		name text NOT NULL,
		detail text,
		image text,
		start_date timestamp with time zone,
		due_date timestamp with time zone,
		type text,
		club_id bigint REFERENCES public.clubs(id) ON DELETE SET NULL
	);

	CREATE TABLE public.exams (
		id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
		name text NOT NULL,
		detail text,
		status text,
		type text,
		image text,
		map_id bigint REFERENCES public.maps(id) ON DELETE SET NULL
	);

	-- LEVEL 3: Many-to-Many Relations
	CREATE TABLE public.conduct (
		user_id uuid REFERENCES public.user_profiles(id) ON DELETE CASCADE,
		exam_id bigint REFERENCES public.exams(id) ON DELETE CASCADE,
		status text,
		completed_date timestamp with time zone DEFAULT now(),
		PRIMARY KEY (user_id, exam_id)
	);

	CREATE TABLE public.get_notifications ( -- ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏≤‡∏Å get ‡πÄ‡∏õ‡πá‡∏ô get_notifications
		user_id uuid REFERENCES public.user_profiles(id) ON DELETE CASCADE,
		notification_id bigint REFERENCES public.notifications(id) ON DELETE CASCADE,
		status text,
		read_date timestamp with time zone,
		reward_claimed boolean DEFAULT false,
		PRIMARY KEY (user_id, notification_id)
	);

	CREATE TABLE public.take (
		exam_id bigint REFERENCES public.exams(id) ON DELETE CASCADE,
		item_id bigint REFERENCES public.items(id) ON DELETE CASCADE,
		status text,
		completed_date timestamp with time zone,
		reward_claimed boolean DEFAULT false,
		PRIMARY KEY (exam_id, item_id)
	);

	CREATE TABLE public.wear (
		character_id bigint REFERENCES public.characters(id) ON DELETE CASCADE,
		item_id bigint REFERENCES public.items(id) ON DELETE CASCADE,
		type text,
		PRIMARY KEY (character_id, item_id)
	);

	CREATE TABLE public.obtain (
		notification_id bigint REFERENCES public.notifications(id) ON DELETE CASCADE,
		item_id bigint REFERENCES public.items(id) ON DELETE CASCADE,
		status text,
		completed_date timestamp with time zone,
		reward_claimed boolean DEFAULT false,
		PRIMARY KEY (notification_id, item_id)
	);

	CREATE TABLE public.do_quests ( -- ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏≤‡∏Å do ‡πÄ‡∏õ‡πá‡∏ô do_quests
		user_id uuid REFERENCES public.user_profiles(id) ON DELETE CASCADE,
		quest_id bigint REFERENCES public.quests(id) ON DELETE CASCADE,
		status text,
		completed_date timestamp with time zone,
		PRIMARY KEY (user_id, quest_id)
	);

	CREATE TABLE public.collect (
		user_id uuid REFERENCES public.user_profiles(id) ON DELETE CASCADE,
		item_id bigint REFERENCES public.items(id) ON DELETE CASCADE,
		quantity int DEFAULT 1,
		acquired_date timestamp with time zone DEFAULT now(),
		PRIMARY KEY (user_id, item_id)
	);

	CREATE TABLE public.attain (
		user_id uuid REFERENCES public.user_profiles(id) ON DELETE CASCADE,
		achievement_id bigint REFERENCES public.achievements(id) ON DELETE CASCADE,
		status text,
		completed_date timestamp with time zone,
		reward_claimed boolean DEFAULT false,
		PRIMARY KEY (user_id, achievement_id)
	);

	CREATE TABLE public.give (
		achievement_id bigint REFERENCES public.achievements(id) ON DELETE CASCADE,
		item_id bigint REFERENCES public.items(id) ON DELETE CASCADE,
		quantity int DEFAULT 1,
		acquired_date timestamp with time zone,
		PRIMARY KEY (achievement_id, item_id)
	);

	CREATE TABLE public.receive (
		quest_id bigint REFERENCES public.quests(id) ON DELETE CASCADE,
		item_id bigint REFERENCES public.items(id) ON DELETE CASCADE,
		quantity int DEFAULT 1,
		PRIMARY KEY (quest_id, item_id)
	);

	-- ==========================================
	-- 1. ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô RLS ‡∏ó‡∏∏‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á
	-- ==========================================
	ALTER TABLE public.maps ENABLE ROW LEVEL SECURITY;
	ALTER TABLE public.notifications ENABLE ROW LEVEL SECURITY;
	ALTER TABLE public.clubs ENABLE ROW LEVEL SECURITY;
	ALTER TABLE public.categories ENABLE ROW LEVEL SECURITY;
	ALTER TABLE public.achievements ENABLE ROW LEVEL SECURITY;
	ALTER TABLE public.user_profiles ENABLE ROW LEVEL SECURITY;
	ALTER TABLE public.characters ENABLE ROW LEVEL SECURITY;
	ALTER TABLE public.items ENABLE ROW LEVEL SECURITY;
	ALTER TABLE public.quests ENABLE ROW LEVEL SECURITY;
	ALTER TABLE public.exams ENABLE ROW LEVEL SECURITY;
	ALTER TABLE public.conduct ENABLE ROW LEVEL SECURITY;
	ALTER TABLE public.get_notifications ENABLE ROW LEVEL SECURITY;
	ALTER TABLE public.take ENABLE ROW LEVEL SECURITY;
	ALTER TABLE public.wear ENABLE ROW LEVEL SECURITY;
	ALTER TABLE public.obtain ENABLE ROW LEVEL SECURITY;
	ALTER TABLE public.do_quests ENABLE ROW LEVEL SECURITY;
	ALTER TABLE public.collect ENABLE ROW LEVEL SECURITY;
	ALTER TABLE public.attain ENABLE ROW LEVEL SECURITY;
	ALTER TABLE public.give ENABLE ROW LEVEL SECURITY;
	ALTER TABLE public.receive ENABLE ROW LEVEL SECURITY;

	-- ==========================================
	-- 2. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏∞ (Game Data) - ‡∏î‡∏π‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô
	-- ==========================================
	CREATE POLICY "Public read maps" ON public.maps FOR SELECT USING (true);
	CREATE POLICY "Public read notifications" ON public.notifications FOR SELECT USING (true);
	CREATE POLICY "Public read clubs" ON public.clubs FOR SELECT USING (true);
	CREATE POLICY "Public read categories" ON public.categories FOR SELECT USING (true);
	CREATE POLICY "Public read achievements" ON public.achievements FOR SELECT USING (true);
	CREATE POLICY "Public read items" ON public.items FOR SELECT USING (true);
	CREATE POLICY "Public read quests" ON public.quests FOR SELECT USING (true);
	CREATE POLICY "Public read exams" ON public.exams FOR SELECT USING (true);

	-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á Relation (Static Data)
	CREATE POLICY "Public read take" ON public.take FOR SELECT USING (true);
	CREATE POLICY "Public read obtain" ON public.obtain FOR SELECT USING (true);
	CREATE POLICY "Public read give" ON public.give FOR SELECT USING (true);
	CREATE POLICY "Public read receive" ON public.receive FOR SELECT USING (true);

	-- ==========================================
	-- 3. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô (User Data) - ‡∏î‡∏π‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô (Public Profile)
	-- ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô Private ‡∏î‡∏π‡πÑ‡∏î‡πâ‡πÅ‡∏Ñ‡πà‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á ‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡πâ USING (true) ‡πÄ‡∏õ‡πá‡∏ô USING (auth.uid() = user_id)
	-- ==========================================
	CREATE POLICY "Public read profiles" ON public.user_profiles FOR SELECT USING (true);
	CREATE POLICY "Public read characters" ON public.characters FOR SELECT USING (true);
	CREATE POLICY "Public read wear" ON public.wear FOR SELECT USING (true);

	-- ==========================================
	-- 4. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß (Private Progress)
	-- ‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢: ‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏î‡∏π‡πÑ‡∏î‡πâ‡∏Ñ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡∏´‡πâ‡∏≤‡∏°‡∏™‡πà‡∏≠‡∏á
	-- ==========================================
	CREATE POLICY "Owner read conduct" ON public.conduct FOR SELECT USING (auth.uid() = user_id);
	CREATE POLICY "Owner read get_notif" ON public.get_notifications FOR SELECT USING (auth.uid() = user_id);
	CREATE POLICY "Owner read do_quests" ON public.do_quests FOR SELECT USING (auth.uid() = user_id);
	CREATE POLICY "Owner read inventory" ON public.collect FOR SELECT USING (auth.uid() = user_id);
	CREATE POLICY "Owner read attain" ON public.attain FOR SELECT USING (auth.uid() = user_id);

	-- ‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ Policy ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö INSERT / UPDATE / DELETE ‡πÄ‡∏•‡∏¢ 
	-- ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤ Client ‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ô‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏î‡∏π

	-- ==========================================
    -- [‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ] 5. ‡∏£‡∏∞‡∏ö‡∏ö Automation (Triggers & Functions)
    -- ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ User ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÉ‡∏´‡∏°‡πà -> ‡∏™‡∏£‡πâ‡∏≤‡∏á Profile ‡πÅ‡∏•‡∏∞ Character ‡πÉ‡∏´‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    -- ==========================================

    -- 5.1 ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á User Profile
    CREATE OR REPLACE FUNCTION public.handle_new_user()
    RETURNS trigger AS $$
    BEGIN
        -- ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡πÅ‡∏Å‡πâ‡∏ä‡∏∑‡πà‡∏≠ column ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á user_profiles (id, email, name)
        INSERT INTO public.user_profiles (id, email, name)
        VALUES (new.id, new.email, new.raw_user_meta_data->>'full_name');
        RETURN new;
    END;
    $$ LANGUAGE plpgsql SECURITY DEFINER;

    -- 5.2 Trigger ‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á Profile
    CREATE TRIGGER on_auth_user_created
        AFTER INSERT ON auth.users
        FOR EACH ROW EXECUTE PROCEDURE public.handle_new_user();

    -- 5.3 ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á Character ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
    CREATE OR REPLACE FUNCTION public.handle_new_user_character()
    RETURNS trigger AS $$
    DECLARE
        char_id bigint; -- ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö ID ‡∏Ç‡∏≠‡∏á Character ‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á
    BEGIN
        -- 1. ‡∏™‡∏£‡πâ‡∏≤‡∏á Character ‡∏õ‡∏Å‡∏ï‡∏¥ ‡πÅ‡∏•‡∏∞‡πÄ‡∏Å‡πá‡∏ö ID ‡πÑ‡∏ß‡πâ‡πÉ‡∏ß‡πâ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ char_id
        INSERT INTO public.characters (user_id)
        VALUES (new.id)
        RETURNING id INTO char_id;
        
        -- 2. ‡πÅ‡∏à‡∏Å Item ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢ _0) ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤ User (Table: collect)
        INSERT INTO public.collect (user_id, item_id, quantity)
        SELECT new.id, id, 1 
        FROM public.items 
        WHERE name LIKE '%_0';

        -- 3. ‡∏™‡∏ß‡∏°‡πÉ‡∏™‡πà Item ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (Table: wear) ‡πÉ‡∏´‡πâ Character ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        INSERT INTO public.wear (character_id, item_id, type)
        SELECT char_id, i.id, c.name
        FROM public.items i
        JOIN public.categories c ON i.category_id = c.id
        WHERE i.name LIKE '%_0';

        RETURN new;
    END;
    $$ LANGUAGE plpgsql SECURITY DEFINER;

    -- 5.4 Trigger ‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á Character
    CREATE TRIGGER on_auth_user_created_character
        AFTER INSERT ON auth.users
        FOR EACH ROW EXECUTE PROCEDURE public.handle_new_user_character();
	
	-- ==========================================
    -- [‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ] 6. ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Level ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (Auto Level Up)
    -- ==========================================

    -- 6.1 Logic Function: ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤ Total EXP -> ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ Level ‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô
    CREATE OR REPLACE FUNCTION public.calculate_level_from_exp(total_exp int) 
    RETURNS int AS $$
    DECLARE
        curr_level int := 1;
        req_exp int := 0;
        remaining_exp int := total_exp;
    BEGIN
        LOOP
            IF curr_level < 6 THEN
                req_exp := 40 * curr_level; -- Level 1-5
            ELSE
                req_exp := 200 + (curr_level * curr_level); -- Level 6+
            END IF;

            IF remaining_exp >= req_exp THEN
                remaining_exp := remaining_exp - req_exp;
                curr_level := curr_level + 1;
            ELSE
                EXIT; 
            END IF;
        END LOOP;
        RETURN curr_level;
    END;
    $$ LANGUAGE plpgsql;

    -- 6.2 Trigger Function: ‡∏ï‡∏±‡∏ß‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç EXP
    CREATE OR REPLACE FUNCTION public.handle_character_exp_update()
    RETURNS trigger AS $$
    BEGIN
        -- ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Level ‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡∏∞‡∏¢‡∏±‡∏î‡πÉ‡∏™‡πà row ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
        NEW.level := public.calculate_level_from_exp(NEW.experience);
        RETURN NEW;
    END;
    $$ LANGUAGE plpgsql;

    -- 6.3 Trigger: ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏•‡∏á‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á characters
    CREATE TRIGGER on_character_exp_change
    BEFORE UPDATE OF experience ON public.characters
    FOR EACH ROW
    EXECUTE PROCEDURE public.handle_character_exp_update();

	-- ==========================================
    -- [‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ] 7. Seed Data (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô)
    -- ==========================================
    INSERT INTO public.categories (name, description) VALUES 
    ('Skin', 'Skin Color'),
    ('Hair', 'Hairstyle'),
    ('Face', 'Facial Expression'),
    ('Body', 'Body Type'),
    ('Cloth', 'Full Body Outfit'),
    ('Shoes', 'Footwear');

    -- Item Default (‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢ _0 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö Animation Name ‡πÉ‡∏ô Rive)
    INSERT INTO public.items (name, description, rarity, category_id) VALUES
    ('Skin_0', 'Default Skin', 'COMMON', (SELECT id FROM public.categories WHERE name='Skin')),
    ('Hair_0', 'Default Hair', 'COMMON', (SELECT id FROM public.categories WHERE name='Hair')),
    ('Face_0', 'Default Face', 'COMMON', (SELECT id FROM public.categories WHERE name='Face')),
    ('Body_0', 'Default Body', 'COMMON', (SELECT id FROM public.categories WHERE name='Body')),
    ('Cloth_0', 'Default Cloth', 'COMMON', (SELECT id FROM public.categories WHERE name='Cloth')),
    ('Shoes_0', 'Default Shoes', 'COMMON', (SELECT id FROM public.categories WHERE name='Shoes'));
`
const disableRLSSQL = `
	-- 1. ‡∏•‡∏ö Policy ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô Schema 'public' ‡πÅ‡∏ö‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
	-- ‡πÄ‡∏£‡∏≤‡πÉ‡∏ä‡πâ PL/pgSQL ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏´‡∏≤ Policy ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß‡∏™‡∏±‡πà‡∏á DROP
	DO $$ 
	DECLARE 
		r RECORD;
	BEGIN 
		FOR r IN (SELECT policyname, tablename FROM pg_policies WHERE schemaname = 'public') 
		LOOP 
			EXECUTE format('DROP POLICY IF EXISTS %I ON public.%I', r.policyname, r.tablename); 
		END LOOP; 
	END $$;

	-- 2. ‡∏™‡∏±‡πà‡∏á‡∏õ‡∏¥‡∏î RLS ‡∏Ç‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ)
	ALTER TABLE public.maps DISABLE ROW LEVEL SECURITY;
	ALTER TABLE public.notifications DISABLE ROW LEVEL SECURITY;
	ALTER TABLE public.clubs DISABLE ROW LEVEL SECURITY;
	ALTER TABLE public.categories DISABLE ROW LEVEL SECURITY;
	ALTER TABLE public.achievements DISABLE ROW LEVEL SECURITY;
	
	ALTER TABLE public.user_profiles DISABLE ROW LEVEL SECURITY;
	ALTER TABLE public.characters DISABLE ROW LEVEL SECURITY;
	ALTER TABLE public.items DISABLE ROW LEVEL SECURITY;
	ALTER TABLE public.quests DISABLE ROW LEVEL SECURITY;
	ALTER TABLE public.exams DISABLE ROW LEVEL SECURITY;
	
	ALTER TABLE public.conduct DISABLE ROW LEVEL SECURITY;
	ALTER TABLE public.get_notifications DISABLE ROW LEVEL SECURITY;
	ALTER TABLE public.take DISABLE ROW LEVEL SECURITY;
	ALTER TABLE public.wear DISABLE ROW LEVEL SECURITY;
	ALTER TABLE public.obtain DISABLE ROW LEVEL SECURITY;
	ALTER TABLE public.do_quests DISABLE ROW LEVEL SECURITY;
	ALTER TABLE public.collect DISABLE ROW LEVEL SECURITY;
	ALTER TABLE public.attain DISABLE ROW LEVEL SECURITY;
	ALTER TABLE public.give DISABLE ROW LEVEL SECURITY;
	ALTER TABLE public.receive DISABLE ROW LEVEL SECURITY;
`
